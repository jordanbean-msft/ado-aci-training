parameters:
  - name: resourceGroupName
  - name: azureServiceConnection
  - name: pathToAdoAgentsDirectory
  - name: environmentName
  - name: azpPool
  - name: azpToken
  - name: azpUrl
  - name: imageName
  - name: imageVersion
  - name: containerRegistryName
  - name: logAnalyticsWorkspaceName
  - name: appName
  - name: location

variables:
  deploymentName: ado-build-agents

steps:
  - task: AzureCLI@2
    displayName: Deploy ADO Build Agents
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az deployment group create --resource-group ${{ parameters.resourceGroupName }} \
                                   --name ${{ variables.deploymentName }}
                                   --template-file ${{ parameters.pathToAdoAgentsDirectory }}/${{ variables.deploymentName }}/main.bicep \
                                   --parameters azpPool=${{ parameters.azpPool }} \
                                   --parameters azpToken=${{ parameters.azpToken }} \
                                   --parameters azpUrl=${{ parameters.azpUrl }} \
                                   --parameters imageName=${{ parameters.imageName }} \
                                   --parameters imageVersion=${{ parameters.imageVersion }} \
                                   --parameters containerRegistryName=${{ parameters.containerRegistryName }} \
                                   --parameters logAnalyticsWorkspaceName=${{ parameters.logAnalyticsWorkspaceName }} \
                                   --parameters appName=${{ parameters.appName }} \
                                   --parameters location=${{ parameters.location }} \
                                   --parameters environment=${{ parameters.environmentName }}

        echo "az deployment group show --resource-group ${{ parameters.resourceGroupName }} --name ${{ variables.deploymentName }}"
        deploymentoutputs=$(az deployment group show --resource-group ${{ parameters.resourceGroupName }} --name ${{ variables.deploymentName }} \
        --query properties.outputs)

        echo 'convert outputs to variables'
        echo $deploymentoutputs | jq -c '. | to_entries[] | [.key, .value.value]' |
        while IFS=$"\n" read -r c; do
          outputname=$(echo "$c" | jq -r '.[0]')
          outputvalue=$(echo "$c" | jq -r '.[1]')
          echo "setting variable $outputname=$outputvalue"
          echo "##vso[task.setvariable variable=$outputname]$outputvalue"
        done